name: Hapus Log Deployments Cloudflare Pages (Spesifik)

on:
  workflow_dispatch:

jobs:
  hapus-log-cloudflare:
    runs-on: ubuntu-latest

    env:
      TARGET_PAGES: "bot" # Ganti dengan proyek spesifik

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Debug Output JSON
        run: |
          API_TOKEN="${{ secrets.CF_API_TOKEN }}"
          ACCOUNT_ID="${{ secrets.CF_ACCOUNT_ID }}"
          CLOUDFLARE_API="https://api.cloudflare.com/client/v4"
          HEADER_AUTH="Authorization: Bearer $API_TOKEN"
          HEADER_CT="Content-Type: application/json"

          echo "ðŸ“Œ Mengecek daftar Pages Projects..."
          RESPONSE=$(curl -s -X GET "$CLOUDFLARE_API/accounts/$ACCOUNT_ID/pages/projects" \
            -H "$HEADER_AUTH" -H "$HEADER_CT")

          echo "ðŸ“Œ Output JSON dari API:"
          echo "$RESPONSE"

      - name: Hapus Log Deployments Cloudflare Pages (Spesifik)
        run: |
          # === Konfigurasi ===
          API_TOKEN="${{ secrets.CF_API_TOKEN }}"
          ACCOUNT_ID="${{ secrets.CF_ACCOUNT_ID }}"
          CLOUDFLARE_API="https://api.cloudflare.com/client/v4"
          HEADER_AUTH="Authorization: Bearer $API_TOKEN"
          HEADER_CT="Content-Type: application/json"

          echo "Mulai proses penghapusan log deployments untuk proyek spesifik..."
          echo

          # === Ambil daftar proyek Pages yang sesuai ===
          IFS=',' read -ra PROJECTS <<< "$TARGET_PAGES"

          for project in "${PROJECTS[@]}"; do
            echo "ðŸ” Memproses Project: $project"

            # === Hapus Semua Deployments ===
            echo "ðŸ“Œ Mengambil daftar Deployments untuk Project: $project..."
            DEPLOYMENTS=$(curl -s -X GET "$CLOUDFLARE_API/accounts/$ACCOUNT_ID/pages/projects/$project/deployments" \
              -H "$HEADER_AUTH" -H "$HEADER_CT" | jq -r '.result[].id')

            if [ -z "$DEPLOYMENTS" ]; then
              echo "âœ… Tidak ada Deployment yang ditemukan untuk Project: $project."
            else
              echo "ðŸš¨ Menghapus Semua Deployments untuk Project: $project..."
              for deployment in $DEPLOYMENTS; do
                curl -s -X DELETE "$CLOUDFLARE_API/accounts/$ACCOUNT_ID/pages/projects/$project/deployments/$deployment" \
                  -H "$HEADER_AUTH" -H "$HEADER_CT"
                echo "ðŸ—‘ï¸ Deployment '$deployment' dihapus dari Project: $project."
              done
            fi
          done

          echo
          echo "ðŸŽ‰ Log deployments untuk proyek spesifik telah dihapus!"
