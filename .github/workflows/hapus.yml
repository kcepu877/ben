- name: List and Delete Old Pages Deployments for "bot"
  run: |
    # Get the list of deployments for the "bot" project using the provided project ID
    deployments=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/$CLOUDFLARE_PROJECT_ID/deployments" \
      -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
      -H "Content-Type: application/json")

    # Print the raw API response for debugging
    echo "API Response: $deployments"

    # Check if the deployments are empty
    if [ "$deployments" == "null" ] || [ -z "$deployments" ]; then
      echo "No deployments found for project 'bot'."
      exit 0
    fi

    # Get the current date in Unix timestamp
    current_date=$(date +%s)

    # Filter deployments older than 30 days (2592000 seconds)
    echo "$deployments" | jq -r '.result[] | select(.created_on | tonumber < ('$current_date' - 2592000)) | .id' | while read deployment_id; do
      echo "Deleting old deployment $deployment_id for 'bot' project"
      curl -X DELETE "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/$CLOUDFLARE_PROJECT_ID/deployments/$deployment_id" \
        -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
        -H "Content-Type: application/json"
    done
